{% extends 'header.html' %}
{% load static %}
{% block content%}
    <style>
        body.sidebar-main-active.right-column-fixed .content-page, body.sidebar-main-active.right-column-fixed{
            margin-right: 0;
        }
        body.sidebar-main-active.right-column-fixed .iq-top-navbar {
            margin-right: 150px;
            /* width: calc(100% - 460px); */
        }
        body.sidebar-main-active.right-column-fixed .content-page, body.sidebar-main-active.right-column-fixed .iq-footer {
            margin-left: 80px;
            margin-right: 0;
        }
        #weather{
                background: #2980B9;
                background: -webkit-linear-gradient(to right, #FFFFFF, #6DD5FA, #81c4f1);
                background: linear-gradient(to right, #FFFFFF, #6DD5FA, #81c4f1);
                min-width: 400px;
        }
    </style>

<body class="sidebar-main-active right-column-fixed header-top-bgcolor">

      <!-- loader END -->
      <!-- Wrapper Start -->
      <div class="wrapper">
         <!-- Sidebar  -->
          {% include 'slide.html' %}
         <!-- TOP Nav Bar -->
          {% include 'top_navbar.html' %}
         <!-- TOP Nav Bar END -->
         <!-- Page Content  -->
         <div id="content-page" class="content-page">
            <div class="container-fluid">
               <div class="row">

                       <div  class="col-sm-6 col-md-6 col-lg-2" >
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                                <div class="d-flex d-flex align-items-center justify-content-between">
                                   <div>
                                       <h2>{% if nombre_vehicules %} {{nombre_vehicules}} {% else %} 0 {% endif %}</h2>
                                       <p class="fontsize-sm m-0">Nombre de voitures</p>
                                   </div>
                                    <a href="{% url 'vehicule:liste_vehicules' %} "> <div class="rounded-circle iq-card-icon dark-icon-light iq-bg-primary " > <i class="ri-roadster-line" ></i></div></a>
                                </div>
                        </div>
                     </div>
                  </div>

                  <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">

                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_conducteurs %} {{nombre_conducteurs}} {% else %} 0 {% endif %}</h2>
                                  <p class="fontsize-sm m-0">Nombre de conducteurs</p>
                              </div>
                            <a href="{% url 'conducteur:tous_les_conducteurs' %}">    <div class="rounded-circle iq-card-icon iq-bg-secondary"><i class="ri-user-line"></i></div></a>
                           </div>
                         </div>
                     </div>
                  </div>
                  <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_incidents %} {{nombre_incidents}} {% else %} 0 {% endif %}</h2>
                                  <p class="fontsize-sm m-0">Nombre d'incidents</p>
                              </div>
                             <div class="rounded-circle iq-card-icon iq-bg-danger"><i class="ri-alert-line"></i></div>
                           </div>
                       </div>
                     </div>
                  </div>
                  <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_deplacements_en_cours %} {{nombre_deplacements_en_cours}} {% else %} 0 {% endif %}</h2>
                                  <p class="fontsize-sm m-0">Déplacements en cours</p>
                              </div>
                                <a href="{% url 'deplacement:liste_deplacement_en_cours' %}">  <div class="rounded-circle iq-card-icon iq-bg-info "><i class="ri-send-plane-2-fill"></i></div></a>
                           </div>
                       </div>
                     </div>
                  </div>
                 <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_deplacement_en_attente %} {{nombre_deplacement_en_attente}} {% else %} 0 {% endif %}</h2>
                                  <p class="fontsize-sm m-0">Déplacements en attente</p>
                              </div>
                        <a href="{% url 'deplacement:liste_deplacement' %}">  <div class="rounded-circle iq-card-icon iq-bg-warning "><i class="fa fa-paper-plane"></i></div></a>
                           </div>
                       </div>
                     </div>
                  </div>
                   <div class="col-sm-6 col-md-6 col-lg-2">
                     <div class="iq-card iq-card-block iq-card-stretch ">
                        <div class="iq-card-body">
                           <div class="d-flex d-flex align-items-center justify-content-between">
                              <div>
                                  <h2>{% if nombre_deplacement_termine %} {{nombre_deplacement_termine}} {% else %} 0 {% endif %}   </h2>
                                  <p class="fontsize-sm m-0">Déplacements total</p>
                              </div>
                             <a href="{% url 'deplacement:liste_deplacement_arrive' %}">    <div class="rounded-circle iq-card-icon iq-bg-success "><i class="bi bi-send-check-fill"></i></div></a>
                           </div>
                       </div>
                     </div>
                  </div>
               </div>
               <div class="row">
                  <div class="col-md-6 col-lg-7">
                     <div class="iq-card iq-card-block iq-card-stretch iq-card-height overflow-hidden">
                        <div class="iq-card-header d-flex justify-content-between">
                           <div class="iq-header-title">
                              <h4 class="card-title">Résumé des véhicules</h4>
                           </div>
                           <div class="iq-card-header-toolbar d-flex align-items-center">
                              <div class="dropdown">
                                 <span class="dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown">
                                 <i class="ri-more-fill"></i>
                                 </span>
{#                                 <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton" >#}
{#                                    <a class="dropdown-item" href="#"><i class="ri-eye-fill mr-2"></i>View</a>#}
{#                                    <a class="dropdown-item" href="#"><i class="ri-delete-bin-6-fill mr-2"></i>Delete</a>#}
{#                                    <a class="dropdown-item" href="#"><i class="ri-pencil-fill mr-2"></i>Edit</a>#}
{#                                    <a class="dropdown-item" href="#"><i class="ri-printer-fill mr-2"></i>Print</a>#}
{#                                    <a class="dropdown-item" href="#"><i class="ri-file-download-fill mr-2"></i>Download</a>#}
{#                                 </div>#}
                              </div>
                           </div>
                        </div>
                        <div class="iq-card-body">
                            <div class="table-responsive" id="vehicules-table">
                              <table class="table mb-0 table-borderless">
                                 <thead>
                                    <tr>
                                       <th scope="col">Marque</th>
                                       <th scope="col">Type commercial</th>
                                       <th scope="col">Numéro d'immatriculation</th>
                                       <th scope="col">Kilométrage</th>
                                        <th scope="col">Disponibilité</th>
                                    </tr>
                                 </thead>
                                 <tbody>
                                    {% for vehicule in vehicule_disponible %}
                                        <tr>
                                            <td>{{ vehicule.marque|title }}</td>
                                            <td>{{ vehicule.type_commercial|title }}</td>
                                            <td>{{ vehicule.numero_immatriculation }}</td>
                                            <td>{{ vehicule.kilometrage }} km/h</td>
                                            <td class="text-center">
                                                <div class="badge badge-pill iq-bg-warning" style="font-size: medium">
                                                    Oui
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                 </tbody>
                              <!-- Ajoutez la pagination -->
                                <div class="pagination" id="pagination-links">
                                   <span class="step-links">
                                      {% if vehicule_disponible.has_previous %}
                                         <a href="?page=1">&laquo; 1</a>
                                         <a href="?page={{ vehicule_disponible.previous_page_number }}">Précédent</a>
                                      {% endif %}

                                      <span class="current">
                                          {{ vehicule_disponible.number }} sur {{ vehicule_disponible.paginator.num_pages }}.
                                      </span>

                                      {% if vehicule_disponible.has_next %}
                                         <a href="?page={{ vehicule_disponible.next_page_number }}">Suivant</a>
                                         <a href="?page={{ vehicule_disponible.paginator.num_pages }}">{{ vehicule_disponible.paginator.num_pages }} &raquo;</a>
                                      {% endif %}
                                   </span>
                                </div>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-6 col-lg-5">
                     <div class="iq-card iq-card-block iq-card-stretch iq-card-height" style="background: transparent;">
                        <div class="iq-card-body rounded p-0" style="background: url({% static 'images/vehicul.jpg' %}) no-repeat;    background-size: cover; height: 490px;">
                          <div class="iq-caption">
                          </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="row">
                  <div class="col-lg-8">
                     <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-header d-flex justify-content-between">
                           <div class="iq-header-title">
                              <h4 class="card-title">Déplacements récents</h4>
                           </div>
                           <div class="iq-card-header-toolbar d-flex align-items-center">
                              <div class="dropdown">
                                 <span class="dropdown-toggle text-primary" id="dropdownMenuButton5" data-toggle="dropdown">
                                 <i class="ri-more-fill"></i>
                                 </span>
                              </div>
                           </div>
                        </div>
                        <div class="iq-card-body">
                           <div class="table-responsive">
                              <table class="table mb-0 table-borderless">
                                 <thead>
                                    <tr>
                                       <th scope="col">Conducteur</th>
                                       <th scope="col">Véhicule</th>
                                       <th scope="col">Date de début</th>
                                       <th scope="col" class="text-center">Status</th>
                                    </tr>
                                 </thead>
                                 <tbody>
                                    {% for en_attente in deplacement_en_attente %}
                                        <tr>
                                            <td>{{ en_attente.conducteur|title }}</td>
                                            <td>{{ en_attente.vehicule|title }}</td>
                                            <td>{{ en_attente.date_depart }}</td>
                                            <td class="text-center" style="font-size: 16px">
                                                <div class="badge badge-pill iq-bg-danger">
                                                    En attente
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    {% for en_cours in deplacement_en_cours %}
                                        <tr>
                                            <td>{{ en_cours.conducteur|title }}</td>
                                            <td>{{ en_cours.vehicule|title }}</td>
                                            <td>{{ en_cours.date_depart }}</td>
                                            <td class="text-center" style="font-size: 16px">
                                                <div class="badge badge-pill iq-bg-warning">
                                                    En cours
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    {% for termine in deplacement_termine %}
                                        <tr>
                                            <td>{{ termine.deplacement.conducteur|title }}</td>
                                            <td>{{ termine.deplacement.vehicule|title }}</td>
                                            <td>{{ termine.deplacement.date_depart }}</td>
                                            <td class="text-center" style="font-size: 16px">
                                                <div class="badge badge-pill iq-bg-success">
                                                    Terminé
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                 </tbody>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="col-lg-4">
                     <div class="iq-card iq-card-block iq-card-stretch iq-card-height" id="weather">
                        <div class="iq-card-header d-flex justify-content-between">
                           <div class="iq-header-title">
                              <h4 class="card-title">Informations météo</h4>
                           </div>
                           <div class="iq-card-header-toolbar d-flex align-items-center">
                              <div class="dropdown">
                                 <span class="dropdown-toggle" id="dropdownMenuButton1" data-toggle="dropdown" >
                                 <i class="ri-more-fill"></i>
                                 </span>
                              </div>
                           </div>
                        </div>
                        <div class="iq-card-body">
                          <div id="weather-info" class="text-center">
                                <input type="text" id="cityInput" placeholder="Entrez une ville" class="form-control">
                                <button class="btn btn-primary mt-2 mb-5" id="btnMeteo">Obtenir la météo</button>
                                <h5 id="country" class="text-capitalize"></h5>
                                <h5 id="weather-city"></h5>
                                <h5 id="weather-description" class="text-capitalize"></h5>
                                <h5 id="temperature" class="text-danger mt-2"></h5>
                          </div>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="row">
                  <div class="col-lg-12 row m-0 p-0">
                     <div class="col-md-12">
                        <div class="iq-card iq-card-block iq-card-stretch ">
                           <div class="iq-card-header d-flex justify-content-between">
                              <div class="iq-header-title">
                                 <h4 class="card-title">Calendrier des déplacements</h4>
                              </div>
                           </div>
                           <div class="iq-card-body">
                               <div id="calendrier"></div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>

            </div>

         </div>

      </div>

      <div class="modal fade" id="eventDeplacement" tabindex="-1" role="dialog" aria-labelledby="eventDeplacementModalLabel" aria-hidden="true">
           <div class="modal-dialog" role="document">
              <div class="modal-content">
                 <div class="modal-header">
                    <h5 class="modal-title text-capitalize text-danger" id="eventDeplacementModalLabel"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                       <span aria-hidden="true">&times;</span>
                    </button>
                 </div>
                 <div class="modal-body">
                    <p class="lead text-capitalize" id="body"></p>
                 </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                 </div>
              </div>
           </div>
      </div>
      <!-- Wrapper END -->
      <!-- Footer -->

{% include 'footer.html' %}
      <!-- Footer END -->
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/locale/fr.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>



<script>
   $(document).ready(function () {
      $('#calendrier').fullCalendar({
         header: {
            left: 'prev, today, next ',
            center: 'title',
            right: 'month, agendaWeek, agendaDay, list'
         },
          footer: false,

          buttonText:{
             today: 'Aujourd\'hui',
              month: 'Mois',
              week: 'Semaine',
              day: 'Jours',
              list: 'Liste'
          },

          height: 500,
          events: '/deplacements_planifies',
          selectable: true,
          selectHelper: true,
          editable: true,
          eventLimit: true,
          locale: 'fr',

         eventClick: function (event) {
             // Afficher une boîte de dialogue modale
            $('#eventDeplacementModalLabel').text(`Déplacement de ${event.title}`);
            $(this).attr('data-toggle', 'modal');
            $(this).attr('data-target', '#eventDeplacement');
             // Récupérer la date de départ de l'événement
            let startDate = new Date(event.start);

            // Définir les noms complets des jours de la semaine et des mois
            let joursSemaine = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            let mois = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

            // Créer une chaîne de format "Jeudi 22 mars"
            let dateString = `${joursSemaine[startDate.getDay()]} ${startDate.getDate()} ${mois[startDate.getMonth()]}`;

            // Mettre à jour le contenu de l'élément HTML avec la date formatée
            $('#body').html(`Date de départ : ${dateString} <br> Durée : ${event.duree} jours <br> Conducteur : ${event.conducteur}`);

         },

         /* dayRender: function (date,cell) {
             let today = $.fullCalendar.moment();
             let newdate = $.fullCalendar.formatDate(date, 'DD-MM-YYYY');
             if (date.get('date')===today.get('date')){
                    cell.css("background", 'yellow');
              }
          },*/

          eventRender: function (event, element) {
            let eventStart = moment(event.start);

            if (eventStart) {
                element.css("background", '#f799a3')
                element.css("font-size", 20)
            } else {
                element.css("background", '#dc8787')
            }
         }
      });
   });
</script>


<script>
    const apiKey = '9745b272e6f312ca99794a979760245c';

    function recupererMeteo(ville) {

            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${ville}&appid=${apiKey}&units=metric&lang=fr`;

            $.ajax({
              url: apiUrl,
              type: 'GET',
              dataType: 'json',
              success: (data) => {
                  $('#weather-info');
                  $('#weather-city').text(`Ville : ${data.name}`);
                  $('#weather-description').text(`Conditions météo : ${data.weather[0].description}`);
                  $('#temperature').text(`Température : ${data.main.temp} °C`);
                  recupererNomPays(data.sys.country);
              },
              error: () => {
                alert('Impossible de charger la météo pour l\'instant.');
              }
            });
    }

    function recupererNomPays(codePays) {

          $.ajax(
          {
              url: `https://restcountries.com/v3/alpha/${codePays}`,
              type: 'GET',
              dataType: 'json',
              success: (data) =>{
                  let nom = data[0].translations.fra.common
                  $('#country').text(`Pays : ${nom}`);
              },
              error: () => {
                  $('#country').text(`Pays : Inconnu`);
              }
          }
        )

    }


    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
            (position) => {
                const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${ position.coords.latitude}&lon=${position.coords.longitude}&appid=${apiKey}&units=metric&lang=fr`;
                $.ajax({
                  url: apiUrl,
                  type: 'GET',
                  dataType: 'json',
                  success: (data) => {
                      $('#weather-info');
                      $('#weather-city').text(`Ville : ${data.name}`);
                      $('#weather-description').text(`Conditions météo : ${data.weather[0].description}`);
                      $('#temperature').text(`Température : ${data.main.temp} °C`);
                      recupererNomPays(data.sys.country);

                  },
                  error: () => {
                    alert('Impossible de charger la météo pour l\'instant.');
                }
            });
            }, erreur, options);
          var options = {
            enableHighAccuracy: true
          }
    }else {
        recupererMeteo('Abidjan');
    }

    function erreur() {
      recupererMeteo('Abidjan');
    }

    $('#btnMeteo').on('click', ()=>{
        let villeChoisie = $('#cityInput').val();
         recupererMeteo(villeChoisie);
    })
</script>

</body>
{% endblock %}